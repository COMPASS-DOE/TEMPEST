---
title: "TEROS QA / QC"
author: "Stephanie Pennington"
date: "6/8/2021"
output: html_document
---

```{r setup, include=FALSE}
##this will use data from the "Current Data" folders

EC_RANGE <- c(0, 20) #dS/m (bulk)
VWC_RANGE <- c(0.00, 0.70 ) #m3/m3
TEMP_RANGE <- c(-40, 60) #degC

# In graphs, TRUE is "ok" while FALSE is "error"
TEST_COLOR_SCALE <- c("TRUE" = "black", "FALSE" = "red")

DAILY_TESTS <- list()

library(readr)
library(lubridate)
library(dplyr)
library(tidyr)
library(ggplot2)
library(kableExtra)
library(plotly)
theme_set(theme_minimal())

# Global chunk options
knitr:: opts_chunk$set(echo = FALSE)

# From Anya's script:
# Helper function: read string vector into a data frame, reshape, and drop NA
source("teros_fileread.R")
source("teros_functions.R")

teros_files <- list.files("~/Dropbox/TEMPEST_PNNL_Data/Current_data/", pattern = "Terosdata.dat", full.names = TRUE)

teros_inventory <- read_csv("../Data/TEROS12/TEROS_Network_Location.csv")
```

``` {r process-data}
teros_primative <- lapply(teros_files, fileread) %>% bind_rows()

teros_primative %>% 
    mutate(Round = floor_date(TIMESTAMP, "3 hours")) %>% # round timestamp to nearest three hours
    group_by(variable, Data_Logger_ID, Data_Table_ID, Round) %>% 
    #na count needs to be before this
    # NAs = sum(!is.finite(M_Value)),
    #           
    summarise(M_Value = mean(value, na.rm = TRUE)) -> teros_raw

teros_raw %>% 
    left_join(teros_inventory, by = c("Data_Logger_ID" = "Data Logger ID", "Data_Table_ID" = "Terosdata table channel")) -> teros_data

nomatch <- anti_join(teros_raw, teros_inventory, by = c("Data_Logger_ID" = "Data Logger ID", "Data_Table_ID" = "Terosdata table channel"))
if(nrow(nomatch) > 0) {
    warning("There were logger/channel combinations that I couldn't find in teros_inventory.csv:")
    nomatch %>% 
        distinct(Data_Logger_ID, Data_Table_ID) %>% 
        kable()
    }

```

# Data Statistics
```{r, warning=FALSE}
# library(skimr)
# skim(teros_summary)
```

# Data visualization {.tabset}

## Control
```{r Control}
p <- ggplot(filter(teros_data, Plot == "Control"), 
            aes(Round, M_Value, group = Data_Table_ID, color = as.factor(Depth))) + 
    geom_line() +
#   coord_cartesian(ylim = VOLTAGE_RANGE) +
    facet_wrap(variable~Data_Logger_ID, scales = "free")
print(p)

```

## Fresh
```{r Fresh}
print(p %+% filter(teros_data, Plot == "Freshwater"))
```

## Salt
```{r Salt}
print(p %+% filter(teros_data, Plot == "Seawater"))
```

# Tests
```{r tests}
 # Summarise nan and out of bound counts

teros_data %>% 
    mutate(Date = as_date(Round), 
           Grid_Letter = substring(`Grid Square`, 1, 1), 
           Grid_Number = substring(`Grid Square`, 2, 2)) %>% 
    pivot_wider(names_from = variable, values_from = M_Value) %>% 
    group_by(Data_Logger_ID, Grid_Letter, Grid_Number, `Junction Box ID`) %>% 
    summarise(T_bounds = teros_bounds(TSOIL, TEMP_RANGE),
              VWC_bounds = teros_bounds(VWC, VWC_RANGE),
              EC_bounds = teros_bounds(EC, EC_RANGE)) -> teros_summary

library(DT)
datatable(teros_summary, 
          rownames = FALSE,
          filter = "top",
          options = list(pageLength = 10, scrollX = TRUE))
```

# Tests - last installation date
```{r}
# we want to report the last known "online" date

# let's create a test data frame for this
dates <- c("2018-07-11", "2018-07-12", "2018-07-11", "2018-07-12")
loggers <- c("A", "A", "B", "B")
values <- c(2, NA, 3, 4)

tibble(dates, loggers, values) -> test_df

test_df %>% 
    filter(is.finite(values)) %>% 
    group_by(loggers) %>% 
    summarise(last_online = max(dates)) -> x

test_df %>% 
    filter(!is.finite(values)) %>% 
    group_by(loggers) %>% 
    summarise(na_days = length(unique(dates))) -> y
# what is an na_day? is it a day with more than x nas or a full day? what do you normally see

left_join(x,y) %>% 
    replace_na(list(na_days = 0))

```


# Spatial Map
```{r spatial}
ggplot(teros_summary, aes(x = Grid_Letter, y = Grid_Number)) + geom_point(aes(color = NAs))-> p

ggplotly(p)

```
